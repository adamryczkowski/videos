= Videos - Video Downloader with Multi-threading Support
:toc:
:toc-placement: preamble
:toclevels: 2

A Python package for downloading videos using yt-dlp with multi-threading support and queue management.

== Features

* Multi-threaded video downloads for improved performance
* Queue-based download management with JSON link files
* Configuration-driven setup via TOML files
* Support for custom video quality settings
* Channel-based organization of downloads
* Progress tracking and logging
* Command-line interface with multiple entry points

== Installation

=== Using Poetry (Recommended)

[source,bash]
----
poetry install
----

=== Using pip

[source,bash]
----
pip install videos
----

== Configuration

Create a `video_downloads.toml` configuration file in your project directory:

[source,toml]
----
video_definition_dir = "/path/to/your/channels"
link_queue_dir = "/path/to/your/channels/links"
target_dir = "/path/to/your/videos"
----

=== Configuration Options

* `video_definition_dir`: Directory containing video definition files
* `link_queue_dir`: Directory for queued download links (JSON files)
* `target_dir`: Target directory for downloaded videos

== Usage

=== Command Line Interface

The package provides three main command-line scripts:

==== Fetch Links

Extract video links and create download queue:

[source,bash]
----
fetch_links
----

This command will:

* Install yt-dlp if not present
* Process video definitions
* Create `.link` files in the queue directory

==== Download All (Multi-threaded)

Download all queued videos using multiple threads:

[source,bash]
----
download_all
----

==== Single-threaded Download

Download videos one at a time:

[source,bash]
----
download_st
----

=== Python API

==== Core Classes

===== Main

The main entry point for downloading videos.

[source,python]
----
from videos import Main

# Initialize with configuration file
main = Main("video_downloads.toml")

# Download all queued videos
main.download()
----

===== Video

Represents a single video to be downloaded.

[source,python]
----
from videos import Video

# Create from a dictionary
video = Video({
    "link": "https://youtube.com/watch?v=...",
    "target_folder": "/path/to/videos",
    "max_height": 1080,
    "browser": "firefox",  # Optional: for cookie-based auth
    "subtitle_languages": ["en", "pl"]  # Optional
})

# Access properties
print(video.link)
print(video.target_folder)
print(video.max_height)
print(video.browser)  # Defaults to "firefox"
print(video.subtitle_languages)  # Defaults to ["pl", "en", "ru"]

# Download the video
video.download()
----

===== Videos

Manages a collection of videos from a configuration file.

[source,python]
----
from videos import Videos

# Load videos from configuration
videos = Videos("video_downloads.toml")

# Iterate over videos
for video in videos:
    print(video.link)
----

==== Utility Functions

[source,python]
----
from videos import download_all_sequential, make_links

# Download all queued videos sequentially (single-threaded)
download_all_sequential("video_downloads.toml")

# Fetch links and create download queue
make_links("video_downloads.toml")
----

==== Multi-threaded Downloads

For concurrent downloads, use the threads module:

[source,python]
----
from videos.threads import main as download_threaded

# Download with default worker count (3 threads)
download_threaded()

# Or with custom worker count
download_threaded(worker_count=5)
----

==== Configuration Constants

The following constants are defined in `videos.common`:

[source,python]
----
from videos.common import (
    LINK_FILE_EXTENSION,        # ".link"
    DEFAULT_MAX_HEIGHT,         # 1080
    DEFAULT_WORKER_COUNT,       # 3
    DEFAULT_SUBTITLE_LANGUAGES, # ["pl", "en", "ru"]
    DEFAULT_BROWSER,            # "firefox"
)
----

== Project Structure

----
videos/
├── __init__.py          # Package initialization and exports
├── main.py              # Main application class
├── functions.py         # Core download and link processing functions
├── threads.py           # Multi-threaded download workers
├── video.py             # Individual video handling
├── videos.py            # Video collection management
├── ifaces.py            # Interface definitions
└── common.py            # Common utilities
----

== How It Works

. *Configuration*: Set up your directories in `video_downloads.toml`
. *Link Generation*: Run `fetch_links` to create `.link` files for each video
. *Queue Processing*: Run `download_all` to process the queue with multiple threads
. *Download*: Videos are downloaded to the target directory and organized

== Dependencies

* Python 3.10+
* yt-dlp: Video downloading with browser cookie support
* toml: Configuration file parsing

== Development

=== Running Tests

[source,bash]
----
poetry run pytest
----

=== Code Quality

[source,bash]
----
# Run all pre-commit hooks
just validate

# Run tests with coverage
poetry run coverage run --source videos -m pytest
poetry run coverage report -m
----

=== Development Dependencies

* pytest ^8.3
* pytest-mock ^3.14
* coverage ^7.6
* pre-commit ^4.0
* pyright ^1.1

== License

This project is developed by Adam Ryczkowski.

== Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

== Troubleshooting

=== Common Issues

* *Permission errors*: Ensure the target directories are writable
* *yt-dlp not found*: The `fetch_links` command automatically installs yt-dlp
* *Configuration errors*: Verify your `video_downloads.toml` file paths exist

=== Logging

The application uses Python's logging module. To see detailed output:

[source,python]
----
import logging
logging.basicConfig(level=logging.INFO)
----

== Version History

* 1.6.0: Code review improvements
  ** Added comprehensive docstrings (Google-style)
  ** Improved error handling with DownloadError
  ** Added type safety with TypedDicts
  ** Configurable browser and subtitle languages
  ** Added interrogate for docstring coverage
  ** Expanded test coverage
* 1.5.3: Multi-threading support improvements

NOTE: The version in `pyproject.toml` is the single source of truth for the package version.
The `videos/_version.py` file should be kept in sync with it.
