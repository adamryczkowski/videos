= Videos - Video Downloader with Multi-threading Support
:toc:
:toc-placement: preamble
:toclevels: 2

A Python package for downloading videos using yt-dlp with multi-threading support and queue management.

== Features

* Multi-threaded video downloads for improved performance
* *Parallel link fetching* with cargo-style progress display
* Queue-based download management with JSON link files
* Configuration-driven setup via TOML files
* Support for custom video quality settings
* Channel-based organization of downloads
* Progress tracking and logging with Rich library
* Retry logic with exponential backoff for resilient fetching
* Command-line interface with multiple entry points

== Installation

=== Using Poetry (Recommended)

[source,bash]
----
poetry install
----

=== Using pip

[source,bash]
----
pip install videos
----

== Configuration

Create a `video_downloads.toml` configuration file in your project directory:

[source,toml]
----
video_definition_dir = "/path/to/your/channels"
link_queue_dir = "/path/to/your/channels/links"
target_dir = "/path/to/your/videos"
----

=== Configuration Options

* `video_definition_dir`: Directory containing video definition files
* `link_queue_dir`: Directory for queued download links (JSON files)
* `target_dir`: Target directory for downloaded videos

== Usage

=== Command Line Interface

The package provides four main command-line scripts:

==== Fetch Links (Parallel)

Extract video links from all channels in parallel with cargo-style progress display:

[source,bash]
----
fetch_links_parallel
----

This is the recommended way to fetch links. It uses multiple worker threads for faster processing.

Options:

* `-w, --workers N`: Number of concurrent worker threads (default: 5)
* `-q, --quiet`: Suppress progress output
* `--max-retries N`: Maximum retry attempts per channel (default: 3)
* `config`: Path to configuration file (default: video_downloads.toml)

Examples:

[source,bash]
----
# Use defaults (5 workers, progress display)
fetch_links_parallel

# Use 10 workers for faster processing
fetch_links_parallel -w 10

# Quiet mode for scripting
fetch_links_parallel -q

# Custom config file
fetch_links_parallel /path/to/config.toml
----

==== Fetch Links (Sequential)

Extract video links sequentially (legacy command):

[source,bash]
----
fetch_links
----

This command will:

* Install yt-dlp if not present
* Process video definitions one at a time
* Create `.link` files in the queue directory

==== Download All (Multi-threaded)

Download all queued videos using multiple threads:

[source,bash]
----
download_all
----

==== Single-threaded Download

Download videos one at a time:

[source,bash]
----
download_st
----

=== Python API

==== Core Classes

===== Main

The main entry point for downloading videos.

[source,python]
----
from videos import Main

# Initialize with configuration file
main = Main("video_downloads.toml")

# Download all queued videos
main.download()
----

===== Video

Represents a single video to be downloaded.

[source,python]
----
from videos import Video

# Create from a dictionary
video = Video({
    "link": "https://youtube.com/watch?v=...",
    "target_folder": "/path/to/videos",
    "max_height": 1080,
    "browser": "firefox",  # Optional: for cookie-based auth
    "subtitle_languages": ["en", "pl"]  # Optional
})

# Access properties
print(video.link)
print(video.target_folder)
print(video.max_height)
print(video.browser)  # Defaults to "firefox"
print(video.subtitle_languages)  # Defaults to ["pl", "en", "ru"]

# Download the video
video.download()
----

===== Videos

Manages a collection of videos from a configuration file.

[source,python]
----
from videos import Videos

# Load videos from configuration
videos = Videos("video_downloads.toml")

# Iterate over videos
for video in videos:
    print(video.link)
----

==== Utility Functions

[source,python]
----
from videos import download_all_sequential, make_links

# Download all queued videos sequentially (single-threaded)
download_all_sequential("video_downloads.toml")

# Fetch links and create download queue
make_links("video_downloads.toml")
----

==== Parallel Link Fetching

For concurrent link fetching with progress display:

[source,python]
----
from videos.parallel_fetch import ParallelFetcher

# Create fetcher with default settings (5 workers)
fetcher = ParallelFetcher("video_downloads.toml")

# Fetch links from all channels in parallel
results = fetcher.fetch_all()

# Get summary statistics
summary = fetcher.get_summary()
print(f"Processed {summary['total_channels']} channels in {summary['elapsed_time']:.1f}s")

# Custom configuration
fetcher = ParallelFetcher(
    conf_file="video_downloads.toml",
    worker_count=10,      # Use 10 workers
    quiet=False,          # Show progress display
    max_retries=5,        # Retry failed channels up to 5 times
)
----

==== Multi-threaded Downloads

For concurrent downloads, use the threads module:

[source,python]
----
from videos.threads import main as download_threaded

# Download with default worker count (3 threads)
download_threaded()

# Or with custom worker count
download_threaded(worker_count=5)
----

==== Configuration Constants

The following constants are defined in `videos.common`:

[source,python]
----
from videos.common import (
    LINK_FILE_EXTENSION,          # ".link"
    DEFAULT_MAX_HEIGHT,           # 1080
    DEFAULT_WORKER_COUNT,         # 3
    DEFAULT_SUBTITLE_LANGUAGES,   # ["pl", "en", "ru"]
    DEFAULT_BROWSER,              # "firefox"
    DEFAULT_PLAYER_CLIENTS,       # ["default", "-android_sdkless"]
    DEFAULT_FFMPEG_ARGS,          # FFmpeg reconnect arguments
    DEFAULT_MIN_SLEEP_INTERVAL,   # 1 second
    DEFAULT_MAX_SLEEP_INTERVAL,   # 5 seconds
)
----

NOTE: The `DEFAULT_PLAYER_CLIENTS` excludes `android_sdkless` which was deprecated by YouTube in 2026.
The `DEFAULT_FFMPEG_ARGS` includes reconnect settings for network resilience.

== Project Structure

----
videos/
├── __init__.py          # Package initialization and exports
├── main.py              # Main application class
├── functions.py         # Core download and link processing functions
├── parallel_fetch.py    # Parallel link fetching with progress display
├── threads.py           # Multi-threaded download workers
├── video.py             # Individual video handling
├── videos.py            # Video collection management
├── ifaces.py            # Interface definitions
├── types.py             # Type definitions (TypedDicts)
└── common.py            # Common utilities
----

== How It Works

. *Configuration*: Set up your directories in `video_downloads.toml`
. *Link Generation*: Run `fetch_links_parallel` to create `.link` files for each video (parallel with progress display)
. *Queue Processing*: Run `download_all` to process the queue with multiple threads
. *Download*: Videos are downloaded to the target directory and organized

== Dependencies

=== Runtime Dependencies

* *Python 3.10+*: Required by yt-dlp since version 2025.10.22
* *Deno 2.0+*: *REQUIRED* for YouTube signature extraction since yt-dlp 2025.11.12
* *Firefox*: Recommended browser for cookie-based authentication (default)
* *FFmpeg*: Required for merging video/audio streams and post-processing

=== Python Dependencies

* yt-dlp: Video downloading with browser cookie support
* toml: Configuration file parsing
* rich: Terminal progress display and formatting

=== Installing Deno

Deno is required for yt-dlp to solve YouTube's JavaScript challenges. Without it, downloads will fail with 403 Forbidden errors.

[source,bash]
----
# Linux/macOS
curl -fsSL https://deno.land/install.sh | sh

# Windows (PowerShell)
irm https://deno.land/install.ps1 | iex

# Or using package managers
# Ubuntu/Debian (via Spack - see spack.yaml)
just setup  # Automatically installs Deno via Spack

# macOS
brew install deno

# Windows
winget install DenoLand.Deno
----

Verify installation:

[source,bash]
----
deno --version
----

== Development

=== Running Tests

[source,bash]
----
poetry run pytest
----

=== Code Quality

[source,bash]
----
# Run all pre-commit hooks
just validate

# Run tests with coverage
poetry run coverage run --source videos -m pytest
poetry run coverage report -m
----

=== Development Dependencies

* pytest ^8.3
* pytest-mock ^3.14
* coverage ^7.6
* pre-commit ^4.0
* pyright ^1.1

== License

This project is developed by Adam Ryczkowski.

== Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

== Troubleshooting

=== Common Issues

==== 403 Forbidden Errors

If you see `HTTP Error 403: Forbidden` or similar errors:

1. *Ensure Deno is installed and in PATH*: yt-dlp requires Deno for YouTube signature extraction since version 2025.11.12
+
[source,bash]
----
deno --version
----

2. *Update yt-dlp to the latest version*:
+
[source,bash]
----
pip install --upgrade yt-dlp
# Or with poetry
poetry update yt-dlp
----

3. *Check if cookies are working*: Firefox cookies are recommended
+
[source,bash]
----
# Test with yt-dlp directly
yt-dlp --cookies-from-browser firefox "https://www.youtube.com/watch?v=VIDEO_ID"
----

4. *YouTube SABR blocking*: As of 2026, YouTube uses Server-Based Adaptive Bit Rate (SABR) to block downloaders. The package is configured to handle this, but you may need to:
   - Use combined formats instead of separate audio/video streams
   - Add sleep intervals between downloads to avoid rate limiting
   - Use a VPN if your IP is blocked

==== "Sign in to confirm you're not a bot" Errors

This indicates YouTube requires authentication:

1. Ensure Firefox is installed and you're logged into YouTube
2. Close Firefox before running downloads (cookie database may be locked)
3. Try exporting cookies manually using a browser extension

==== Network Errors / Incomplete Downloads

The package includes FFmpeg reconnect arguments for network resilience. If downloads still fail:

1. Check your internet connection
2. Try reducing the number of concurrent workers
3. Increase sleep intervals in configuration

==== Permission Errors

* Ensure the target directories are writable
* Check that the Spack environment is activated if using Spack-managed dependencies

==== yt-dlp Not Found

The `fetch_links` command automatically installs yt-dlp. If issues persist:

[source,bash]
----
pip install yt-dlp
----

==== Configuration Errors

Verify your `video_downloads.toml` file paths exist and are accessible.

=== Logging

The application uses Python's logging module. To see detailed output:

[source,python]
----
import logging
logging.basicConfig(level=logging.INFO)
----

=== Debugging Downloads

For verbose output when troubleshooting:

[source,bash]
----
# Run with debug logging
python -c "
import logging
logging.basicConfig(level=logging.DEBUG)
from videos.main import download
download()
"
----

== Version History

* 1.7.0: Parallel link fetching
  ** Added `fetch_links_parallel` command with cargo-style progress display
  ** Parallel processing with configurable worker count (default: 5)
  ** Rich-based progress bars with spinner, percentage, M/N count, elapsed/remaining time
  ** Retry logic with exponential backoff for resilient fetching
  ** Per-channel error handling - continues processing on failure
  ** Graceful shutdown support
  ** 42 new tests for parallel fetching functionality
* 1.6.0: Code review improvements
  ** Added comprehensive docstrings (Google-style)
  ** Improved error handling with DownloadError
  ** Added type safety with TypedDicts
  ** Configurable browser and subtitle languages
  ** Added interrogate for docstring coverage
  ** Expanded test coverage
* 1.5.3: Multi-threading support improvements

NOTE: The version in `pyproject.toml` is the single source of truth for the package version.
The `videos/_version.py` file should be kept in sync with it.
